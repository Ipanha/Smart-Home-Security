version: "3.8"

services:
  # The API Gateway (Nginx)
  api-gateway:
    image: nginx:latest
    ports:
      - "8080:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - user-home-service
      - authentication-service
      - device-service
      - mqtt-broker
    networks:
      - smart-home-net
    links:
      - "user-home-service"
      - "authentication-service"
      - "device-service" 
      - "mqtt-broker"

    mqtt-broker:
    image: eclipse-mosquitto:latest
    ports:
      - "1883:1883" # Standard MQTT port
      - "9001:9001" # For WebSocket connections
    networks:
      - smart-home-net
      
  # The User & Home API Service
  user-home-service:
    build:
      context: ./services/user-home-service
      dockerfile: Dockerfile
    ports:
      - "8001:8000"
    volumes:
      - ./services/user-home-service:/var/www/html
    depends_on:
      - db-user-home
    networks:
      - smart-home-net

  # The Database for the User & Home Service
  db-user-home:
    image: mysql:8.0
    ports:
      - "33061:3306"
    environment:
      MYSQL_DATABASE: user_home_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: rootpassword
    volumes:
      - user_home_db_data:/var/lib/mysql
    networks:
      - smart-home-net

  # The Authentication API Service
  authentication-service:
    build:
      context: ./services/authentication-service
      dockerfile: Dockerfile
    ports:
      - "8002:8000"
    volumes:
      - ./services/authentication-service:/var/www/html
    depends_on:
      - db-auth
    environment:
      DB_HOST: db-auth
      DB_DATABASE: auth_db
      DB_USERNAME: user
      DB_PASSWORD: password
    networks:
      - smart-home-net

  # The Database for the Authentication Service
  db-auth:
    image: mysql:8.0
    ports:
      - "33062:3306"
    environment:
      MYSQL_DATABASE: auth_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: rootpassword
    volumes:
      - auth_db_data:/var/lib/mysql
    networks:
      - smart-home-net

  # --- EDIT HERE: ADD THE NEW DEVICE SERVICE AND ITS DATABASE ---
  
  # The Device Management Service
  device-service:
    build:
      context: ./services/device-service
      dockerfile: Dockerfile
    ports:
      - "8003:8000" # Use a new port
    volumes:
      - ./services/device-service:/var/www/html
    depends_on:
      - db-device
    environment:
      DB_HOST: db-device
      DB_DATABASE: device_db
      DB_USERNAME: user
      DB_PASSWORD: password
    networks:
      - smart-home-net

  # The Database for the Device Management Service
  db-device:
    image: mysql:8.0
    ports:
      - "33063:3306" # Use a new port
    environment:
      MYSQL_DATABASE: device_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: rootpassword
    volumes:
      - device_db_data:/var/lib/mysql
    networks:
      - smart-home-net

networks:
  smart-home-net:
    driver: bridge

volumes:
  user_home_db_data:
  auth_db_data:
  device_db_data: 