version: "3.8"

services:
  # The API Gateway (Nginx)
  api-gateway:
    image: nginx:latest
    ports:
      - "8080:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - user-home-service
      - authentication-service
      - device-service
      - mqtt-broker
    networks:
      - smart-home-net
    links:
      - "user-home-service"
      - "authentication-service"
      - "device-service"
      - "mqtt-broker"

  # The MQTT Broker for real-time communication
  mqtt-broker:
    image: eclipse-mosquitto:latest
    ports:
      - "1883:1883"
      - "9001:9001"
    networks:
      - smart-home-net

  # The User & Home API Service (NoSQL)
  user-home-service:
    build:
      context: ./services/user-home-service
      dockerfile: Dockerfile
    volumes:
      - ./services/user-home-service:/var/www/html
    networks:
      - smart-home-net
    depends_on:
      - db-user-home

  # The Database for the User & Home Service (MongoDB)
  db-user-home:
    image: mongo:latest
    ports:
      - "27017:27017" # Default MongoDB port
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: rootpassword
    volumes:
      - user_home_db_data:/data/db
    networks:
      - smart-home-net

  # The Authentication API Service (NoSQL)
  authentication-service:
    build:
      context: ./services/authentication-service
      dockerfile: Dockerfile
    volumes:
      - ./services/authentication-service:/var/www/html
    ports:                  # <--- THIS WAS MISSING
      - "8000:8000"         # <--- THIS EXPOSES THE PORT TO YOUR BROWSER
    networks:
      - smart-home-net
    depends_on:
      - db-auth

  # The Database for the Authentication Service (MongoDB)
  db-auth:
    image: mongo:latest
    ports:
      - "27018:27017" # Use a new external port
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: rootpassword
    volumes:
      - auth_db_data:/data/db
    networks:
      - smart-home-net

  # The Device Management Service (NoSQL)
  device-service:
    build:
      context: ./services/device-service
      dockerfile: Dockerfile
    volumes:
      - ./services/device-service:/var/www/html
    networks:
      - smart-home-net
    depends_on:
      - db-device

  # The Database for the Device Management Service (MongoDB)
  db-device:
    image: mongo:latest
    ports:
      - "27019:27017" # Use a new external port
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: rootpassword
    volumes:
      - device_db_data:/data/db
    networks:
      - smart-home-net

networks:
  smart-home-net:
    driver: bridge

volumes:
  user_home_db_data:
  auth_db_data:
  device_db_data: